# Available variables: employee, contract, payslip, rules, categories, worked_days, inputs

# Initialize the deduction amount
loan_deduction_amount = 0.0
installment_name = ""

# 1. Search for a confirmed loan for the current employee using payslip.env
loan = payslip.env['hr.loan'].search([('employee_id', '=', employee.id),('state', '=', 'confirm')], limit=1)

if loan:
    # 2. Search for the first unpaid installment line
    unpaid_installment = payslip.env['hr.loan.installment.line'].search([('hr_loan_id', '=', loan.id),('state', '=', 'draft')], limit=1, order='id asc')

    if unpaid_installment:
        # 3. Take the amount and name of the first unpaid installment
        loan_deduction_amount = unpaid_installment.amount
        installment_name = unpaid_installment.name

# Set the result to the amount to be deducted
# This amount will be used as the value for the payroll rule
result = -loan_deduction_amount